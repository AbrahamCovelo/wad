/*! wad 2014-05-27 */
var Wad=function(){var a=window.AudioContext||window.webkitAudioContext,b=new a;getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.getUserMedia,getUserMedia&&(getUserMedia=getUserMedia.bind(navigator));var c=function(){Math.seed=6,Math.seededRandom=function(a,b){a=a||1,b=b||0,Math.seed=(9301*Math.seed+49297)%233280;var c=Math.seed/233280;return b+c*(a-b)};for(var a=2*b.sampleRate,c=b.createBuffer(1,a,b.sampleRate),d=c.getChannelData(0),e=0;a>e;e++)d[e]=2*Math.seededRandom()-1;return c}(),d=function(a){return"[object Array]"===Object.prototype.toString.call(a)},e=function(a,b){a.env={attack:b.env?b.env.attack||0:0,decay:b.env?b.env.decay||0:0,sustain:b.env?b.env.sustain||1:1,hold:b.env?b.env.hold||4:4,release:b.env?b.env.release||0:0},a.defaultEnv={attack:b.env?b.env.attack||0:0,decay:b.env?b.env.decay||0:0,sustain:b.env?b.env.sustain||1:1,hold:b.env?b.env.hold||4:4,release:b.env?b.env.release||0:0}},f=function(a,b){if(b.filter)if(d(b.filter))b.filter.forEach(function(b){f(a,{filter:b})});else{a.filter=a.filter||[];var c={type:b.filter.type,frequency:b.filter.frequency,q:b.filter.q||1};b.filter.env&&(c.env={attack:b.filter.env.attack,frequency:b.filter.env.frequency}),a.filter.push(c)}},g=function(a,c){var d=new XMLHttpRequest;d.open("GET",a.source,!0),d.responseType="arraybuffer",a.playable--,d.onload=function(){b.decodeAudioData(d.response,function(b){a.decodedBuffer=b,c&&c(),a.playable++,a.playOnLoad&&a.play(a.playOnLoadArg)})},d.send()},h=function(a,b){b.vibrato&&(a.vibrato={shape:b.vibrato.shape||"sine",speed:b.vibrato.speed||1,magnitude:b.vibrato.magnitude||5,attack:b.vibrato.attack||0})},i=function(a,b){b.tremolo&&(a.tremolo={shape:b.tremolo.shape||"sine",speed:b.tremolo.speed||1,magnitude:b.tremolo.magnitude||5,attack:b.tremolo.attack||1})},j=function(a,c){if(c.reverb){a.reverb={wet:c.reverb.wet||1};var d=c.reverb.impulse||l.defaultImpulse,e=new XMLHttpRequest;e.open("GET",d,!0),e.responseType="arraybuffer",a.playable--,e.onload=function(){b.decodeAudioData(e.response,function(b){a.reverb.buffer=b,a.playable++,a.playOnLoad&&a.play(a.playOnLoadArg)})},e.send()}},k=function(a,c){console.log("set up mic"),getUserMedia({audio:!0,video:!1},function(d){console.log("got stream"),a.nodes=[],a.mediaStreamSource=b.createMediaStreamSource(d),a.nodes.push(a.mediaStreamSource),a.gain=b.createGain(),a.gain.gain.value=a.volume,a.nodes.push(a.gain),a.filter&&r(a,c),a.reverb&&(a.reverb.node=b.createConvolver(),a.reverb.node.buffer=a.reverb.buffer,a.reverb.gain=b.createGain(),a.reverb.gain.gain.value=a.reverb.wet,a.nodes.push(a.reverb.node),a.nodes.push(a.reverb.gain)),a.panning&&(a.panning.node=b.createPanner(),a.panning.node.setPosition(a.panning.location[0],a.panning.location[1],a.panning.location[2]),a.nodes.push(a.panning.node)),console.log(a)},function(a){console.log(a)})},l=function(a){this.source=a.source,this.destination=a.destination||b.destination,this.volume=a.volume||1,this.defaultVolume=this.volume,this.playable=1,this.pitch=l.pitches[a.pitch]||a.pitch||440,this.globalReverb=a.globalReverb||!1,this.gain=[],e(this,a),f(this,a),h(this,a),i(this,a),j(this,a),this.constructExternalFx(a,b),this.panning="panning"in a?"number"==typeof a.panning?{location:[a.panning,0,0]}:{location:[a.panning[0],a.panning[1],a.panning[2]]}:{location:[0,0,0]},"noise"===this.source?this.decodedBuffer=c:"mic"===this.source?k(this,a):this.source in{sine:0,sawtooth:0,square:0,triangle:0}||g(this,a.callback)},m=function(a,c){a.filter.forEach(function(a){a.node.frequency.linearRampToValueAtTime(a.frequency,b.currentTime+c.wait),a.node.frequency.linearRampToValueAtTime(a.env.frequency,b.currentTime+a.env.attack+c.wait)})},n=function(a,c){a.gain[0].gain.linearRampToValueAtTime(1e-4,b.currentTime+c.wait),a.gain[0].gain.linearRampToValueAtTime(a.volume,b.currentTime+a.env.attack+c.wait),a.gain[0].gain.linearRampToValueAtTime(a.volume*a.env.sustain,b.currentTime+a.env.attack+a.env.decay+c.wait),a.gain[0].gain.linearRampToValueAtTime(1e-4,b.currentTime+a.env.attack+a.env.decay+a.env.hold+a.env.release+c.wait),a.soundSource.start(b.currentTime+c.wait),a.soundSource.stop(b.currentTime+a.env.attack+a.env.decay+a.env.hold+a.env.release+c.wait)},o=function(a){for(var b=1;b<a.nodes.length;b++)a.nodes[b-1].connect(a.nodes[b]),a.nodes[b]instanceof ConvolverNode&&a.nodes[b-1].connect(a.nodes[b+2]);a.nodes[a.nodes.length-1].connect(a.destination),l.reverb&&a.globalReverb&&(a.nodes[a.nodes.length-1].connect(l.reverb.node),l.reverb.node.connect(l.reverb.gain),l.reverb.gain.connect(a.destination))},p=function(a,c){a.soundSource=b.createOscillator(),a.soundSource.type=a.source,a.soundSource.frequency.value=c&&c.pitch?c.pitch in l.pitches?l.pitches[c.pitch]:c.pitch:a.pitch},q=function(a,b){b&&b.env?(a.env.attack=b.env.attack||a.defaultEnv.attack,a.env.decay=b.env.decay||a.defaultEnv.decay,a.env.sustain=b.env.sustain||a.defaultEnv.sustain,a.env.hold=b.env.hold||a.defaultEnv.hold,a.env.release=b.env.release||a.defaultEnv.release):a.env={attack:a.defaultEnv.attack,decay:a.defaultEnv.decay,sustain:a.defaultEnv.sustain,hold:a.defaultEnv.hold,release:a.defaultEnv.release}},r=function(a,c){a.filter.forEach(function(d,e){d.node=b.createBiquadFilter(),d.node.type=d.type,d.node.frequency.value=c.filter[e].frequency||d.frequency,d.node.Q.value=c.filter[e].q||d.q,(c.filter[e].env||a.filter[e].env&&"mic"!==a.source)&&(d.env={attack:c.filter[e].env.attack||a.filter[e].env.attack,frequency:c.filter[e].env.frequency||a.filter[e].env.frequency}),a.nodes.push(d.node)})},s=function(a,b){b&&b.filter&&a.filter?(d(b.filter)||(b.filter=[b.filter]),r(a,b)):a.filter&&r(a,a)},t=function(a){a.reverb.node=b.createConvolver(),a.reverb.node.buffer=a.reverb.buffer,a.reverb.gain=b.createGain(),a.reverb.gain.gain.value=a.reverb.wet,a.nodes.push(a.reverb.node),a.nodes.push(a.reverb.gain)},u=function(a,c){if(c&&c.panning||a.panning){if(a.panning.node=b.createPanner(),c&&c.panning)if("number"==typeof c.panning)var d=[c.panning,0,0];else var d=[c.panning[0],c.panning[1],c.panning[2]];else var d=[0,0,0];a.panning.node.setPosition(d[0],d[1],d[2]),a.nodes.push(a.panning.node)}},v=function(a){a.vibrato.wad=new l({source:a.vibrato.shape,pitch:a.vibrato.speed,volume:a.vibrato.magnitude,env:{attack:a.vibrato.attack},destination:a.soundSource.frequency}),a.vibrato.wad.play()},w=function(a){a.tremolo.wad=new l({source:a.tremolo.shape,pitch:a.tremolo.speed,volume:a.tremolo.magnitude,env:{attack:a.tremolo.attack},destination:a.gain[0].gain}),a.tremolo.wad.play()};l.prototype.constructExternalFx=function(){},l.prototype.setUpExternalFxOnPlay=function(){},l.prototype.play=function(a){if(this.playable<1)this.playOnLoad=!0,this.playOnLoadArg=a;else if("mic"===this.source)console.log("mic play"),o(this);else{if(this.nodes=[],a&&!a.wait&&(a.wait=0),!a)var a={wait:0};this.volume=a&&a.volume?a.volume:this.defaultVolume,this.source in{sine:0,sawtooth:0,square:0,triangle:0}?p(this,a):(this.soundSource=b.createBufferSource(),this.soundSource.buffer=this.decodedBuffer,"noise"===this.source&&(this.soundSource.loop=!0)),this.nodes.push(this.soundSource),q(this,a),s(this,a),this.setUpExternalFxOnPlay(a,b),this.gain.unshift(b.createGain()),this.gain[0].label=a.label,this.nodes.push(this.gain[0]),this.reverb&&t(this,a),u(this,a),o(this),this.filter&&this.filter.env&&m(this,a),n(this,a),this.vibrato&&v(this,a),this.tremolo&&w(this,a)}},l.prototype.setVolume=function(a){this.defaultVolume=a,this.gain.length>0&&(this.gain[0].gain.value=a)},l.prototype.setPanning=function(a){"number"==typeof a?this.panning.node.setPosition(a,this.panning.location[1],this.panning.location[2]):this.panning.node.setPosition(a[0],a[1],a[2])},l.prototype.stop=function(a){if("mic"!==this.source){if(a)for(var c=0;c<this.gain.length;c++)this.gain[c].label===a&&this.gain[c].gain.linearRampToValueAtTime(1e-4,b.currentTime+this.env.release);this.gain[0].gain.linearRampToValueAtTime(1e-4,b.currentTime+this.env.release)}else this.mediaStreamSource.disconnect(0)},l.defaultImpulse="http://www.codecur.io/us/sendaudio/widehall.wav",l.setGlobalReverb=function(a){l.reverb={},l.reverb.node=b.createConvolver(),l.reverb.gain=b.createGain(),l.reverb.gain.gain.value=a.wet;var c=a.impulse||l.defaultImpulse,d=new XMLHttpRequest;d.open("GET",c,!0),d.responseType="arraybuffer",d.onload=function(){b.decodeAudioData(d.response,function(a){l.reverb.node.buffer=a})},d.send()},l.pitches={A0:27.5,"A#0":29.1352,Bb0:29.1352,B0:30.8677,C1:32.7032,"C#1":34.6478,Db1:34.6478,D1:36.7081,"D#1":38.8909,Eb1:38.8909,E1:41.2034,F1:43.6535,"F#1":46.2493,Gb1:46.2493,G1:48.9994,"G#1":51.9131,Ab1:51.9131,A1:55,"A#1":58.2705,Bb1:58.2705,B1:61.7354,C2:65.4064,"C#2":69.2957,Db2:69.2957,D2:73.4162,"D#2":77.7817,Eb2:77.7817,E2:82.4069,F2:87.3071,"F#2":92.4986,Gb2:92.4986,G2:97.9989,"G#2":103.826,Ab2:103.826,A2:110,"A#2":116.541,Bb2:116.541,B2:123.471,C3:130.813,"C#3":138.591,Db3:138.591,D3:146.832,"D#3":155.563,Eb3:155.563,E3:164.814,F3:174.614,"F#3":184.997,Gb3:184.997,G3:195.998,"G#3":207.652,Ab3:207.652,A3:220,"A#3":233.082,Bb3:233.082,B3:246.942,C4:261.626,"C#4":277.183,Db4:277.183,D4:293.665,"D#4":311.127,Eb4:311.127,E4:329.628,F4:349.228,"F#4":369.994,Gb4:369.994,G4:391.995,"G#4":415.305,Ab4:415.305,A4:440,"A#4":466.164,Bb4:466.164,B4:493.883,C5:523.251,"C#5":554.365,Db5:554.365,D5:587.33,"D#5":622.254,Eb5:622.254,E5:659.255,F5:698.456,"F#5":739.989,Gb5:739.989,G5:783.991,"G#5":830.609,Ab5:830.609,A5:880,"A#5":932.328,Bb5:932.328,B5:987.767,C6:1046.5,"C#6":1108.73,Db6:1108.73,D6:1174.66,"D#6":1244.51,Eb6:1244.51,E6:1318.51,F6:1396.91,"F#6":1479.98,Gb6:1479.98,G6:1567.98,"G#6":1661.22,Ab6:1661.22,A6:1760,"A#6":1864.66,Bb6:1864.66,B6:1975.53,C7:2093,"C#7":2217.46,Db7:2217.46,D7:2349.32,"D#7":2489.02,Eb7:2489.02,E7:2637.02,F7:2793.83,"F#7":2959.96,Gb7:2959.96,G7:3135.96,"G#7":3322.44,Ab7:3322.44,A7:3520,"A#7":3729.31,Bb7:3729.31,B7:3951.07,C8:4186.01},l.pitchesArray=["C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8"],l.midiInstrument={play:function(){console.log("playing midi")},stop:function(){console.log("stopping midi")}},l.midiMap=function(a){console.log(a.receivedTime,a.data),144===a.data[0]?(console.log("note"),0===a.data[2]?l.midiInstrument.stop(l.pitchesArray[a.data[1]]):a.data[2]>0&&(console.log(l.pitchesArray[a.data[1]]),l.midiInstrument.play({pitch:l.pitchesArray[a.data[1]],label:l.pitchesArray[a.data[1]]}))):176===a.data[0]?console.log("controller"):224===a.data[0]&&console.log("pitch bend")};var x=null,y=function(a){console.log("got midi access"),x=a;var b=x.inputs();b[0].onmidimessage=l.midiMap},z=function(a){console.log("uh-oh! Something went wrong!  Error code: "+a.code)};return navigator.requestMIDIAccess().then(y,z),l.presets={hiHatClosed:{source:"noise",env:{attack:.001,decay:.008,sustain:.2,hold:.03,release:.01},filter:{type:"highpass",frequency:400,q:1}},snare:{source:"noise",env:{attack:.001,decay:.01,sustain:.2,hold:.03,release:.02},filter:{type:"bandpass",frequency:300,q:.18}},hiHatOpen:{source:"noise",env:{attack:.001,decay:.008,sustain:.2,hold:.43,release:.01},filter:{type:"highpass",frequency:100,q:.2}},ghost:{source:"square",volume:.3,env:{attack:.01,decay:.002,sustain:.5,hold:2.5,release:.3},filter:{type:"lowpass",frequency:600,q:7,env:{attack:.7,frequency:1600}},vibrato:{attack:8,speed:8,magnitude:100}},piano:{source:"square",volume:1.4,env:{attack:.01,decay:.005,sustain:.2,hold:.015,release:.3},filter:{type:"lowpass",frequency:1200,q:8.5,env:{attack:.2,frequency:600}}}},l}();